<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>YourLanguageMate</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Главное меню */
        .main-menu {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 600px;
            width: 100%;
            animation: slideInUp 0.6s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .main-menu h1 {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            letter-spacing: -0.02em;
        }

        .main-menu h2 {
            font-size: 1.25rem;
            color: #666;
            font-weight: 400;
            margin-bottom: 30px;
        }

        .status-section {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .status-section h3 {
            font-size: 1rem;
            color: #64748b;
            margin-bottom: 10px;
            font-weight: 500;
        }

        #serverStatus {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 0.9rem;
            color: #475569;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-ok {
            background: #10b981;
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        }

        .status-error {
            background: #ef4444;
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        }

        .status-loading {
            background: #f59e0b;
            box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7);
        }

        .status-warning {
            background: #f59e0b;
            box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7);
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .language-buttons {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .language-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 20px 24px;
            border-radius: 16px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .language-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .language-btn:hover::before {
            left: 100%;
        }

        .language-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .language-btn:active {
            transform: translateY(0);
        }

        .language-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Выбор персонажа */
        .character-select {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 800px;
            width: 100%;
            animation: slideInUp 0.6s ease-out;
        }

        .character-header {
            margin-bottom: 30px;
        }

        .character-header h2 {
            font-size: 2rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 10px;
        }

        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-top: 30px;
        }

        .character-card {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: 20px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .character-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea, #764ba2);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1;
        }

        .character-card:hover::before {
            opacity: 0.05;
        }

        .character-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .character-avatar {
            font-size: 4rem;
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
        }

        .character-card h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 15px;
            position: relative;
            z-index: 2;
        }

        .character-card p {
            color: #64748b;
            font-size: 1rem;
            line-height: 1.6;
            position: relative;
            z-index: 2;
        }

        /* Чат */
        .chat-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 900px;
            width: 100%;
            height: 80vh;
            display: flex;
            flex-direction: column;
            animation: slideInUp 0.6s ease-out;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px 30px;
            border-radius: 24px 24px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .chat-info {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .clear-history-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .clear-history-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        #errorContainer {
            padding: 15px 30px;
            background: #fef2f2;
            color: #dc2626;
            border-bottom: 1px solid #fecaca;
            display: none;
        }

        .messages {
            flex: 1;
            padding: 20px 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            max-width: 80%;
            padding: 16px 20px;
            border-radius: 18px;
            animation: messageSlideIn 0.3s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 6px;
        }

        .message.assistant {
            background: #f1f5f9;
            color: #1e293b;
            align-self: flex-start;
            border-bottom-left-radius: 6px;
            border: 1px solid #e2e8f0;
        }

        .message-content {
            white-space: pre-wrap;
            line-height: 1.5;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .message-content strong {
            font-weight: 600;
            color: inherit;
        }

        .message-content em {
            font-style: italic;
        }

        .message.user .message-content {
            color: white;
        }

        .message.assistant .message-content {
            color: #1e293b;
        }

        .input-form {
            padding: 20px 30px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 12px;
            background: #f8fafc;
            border-radius: 0 0 24px 24px;
        }

        .message-input {
            flex: 1;
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .message-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .send-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Кнопка назад */
        .back-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #e2e8f0;
            color: #64748b;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: white;
            color: #1e293b;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .main-menu, .character-select, .chat-container {
                padding: 20px;
                border-radius: 16px;
            }
            
            .main-menu h1 {
                font-size: 2rem;
            }
            
            .character-grid {
                grid-template-columns: 1fr;
            }
            
            .chat-container {
                height: 90vh;
            }
            
            .message {
                max-width: 90%;
            }
        }

        /* Скроллбар */
        .messages::-webkit-scrollbar {
            width: 6px;
        }

        .messages::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .messages::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .messages::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Анимация загрузки */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Главное меню -->
        <div id="mainMenu" class="main-menu">
            <h1>YourLanguageMate</h1>
            <h2>Выберите язык для обучения:</h2>
            <div class="status-section">
                <h3>🖥️ Статус сервера</h3>
                <div id="serverStatus">
                    <span class="status-indicator status-loading"></span>
                    <span>Проверка подключения...</span>
                </div>
            </div>
            <div class="language-buttons">
                <button class="language-btn" onclick="selectLanguage('en')" id="enBtn">🇺🇸 Английский</button>
                <button class="language-btn" onclick="selectLanguage('ru')" id="ruBtn">🇷🇺 Русский</button>
                <button class="language-btn" onclick="selectLanguage('es')" id="esBtn">🇪🇸 Испанский</button>
            </div>
        </div>

        <!-- Выбор персонажа -->
        <div id="characterSelect" class="character-select" style="display: none;">
            <button class="back-btn" onclick="showMainMenu()">← Назад к языкам</button>
            <div class="character-header">
                <h2 id="characterTitle">Выберите персонажа для изучения <span id="selectedLanguageName"></span></h2>
            </div>
            <div class="character-grid">
                <div class="character-card" onclick="selectCharacter('male')">
                    <div class="character-avatar">👨‍🏫</div>
                    <h3>Алекс</h3>
                    <p id="maleDescription">Опытный преподаватель</p>
                </div>
                <div class="character-card" onclick="selectCharacter('female')">
                    <div class="character-avatar">👩‍🏫</div>
                    <h3>Мария</h3>
                    <p id="femaleDescription">Дружелюбная наставница</p>
                </div>
            </div>
        </div>

        <!-- Чат -->
        <div id="chatContainer" class="chat-container" style="display: none;">
            <button class="back-btn" onclick="showCharacterSelect()">← Назад к персонажам</button>
            <div class="chat-header">
                <h2 id="chatTitle">Чат</h2>
                <div class="chat-info">
                    <span id="chatLanguage"></span> • <span id="chatCharacter"></span>
                    <button class="clear-history-btn" onclick="clearCurrentChat()" title="Очистить историю чата">🗑️</button>
                </div>
            </div>
            <div id="errorContainer"></div>
            <div id="messages" class="messages"></div>
            <form class="input-form" onsubmit="sendMessage(event)">
                <input 
                    type="text" 
                    id="messageInput" 
                    class="message-input" 
                    placeholder="Введите сообщение..."
                    required
                >
                <button type="submit" id="sendBtn" class="send-btn">Отправить</button>
            </form>
        </div>
    </div>

    <script>
        // Версия приложения для принудительного обновления кэша
        const APP_VERSION = '1.3.0';
        console.log('YourLanguageMate версия:', APP_VERSION);
        
        let selectedLanguage = null;
        let selectedCharacter = null;
        let chatMessages = [];
        let serverStatus = 'loading';

        const testPrompts = {
            en: "Hello! I'm your English tutor. Let's start with a simple conversation. How are you today?",
            ru: "Привет! Я ваш преподаватель русского языка. Давайте начнем с простого разговора. Как дела?",
            es: "¡Hola! Soy tu tutor de español. Empecemos con una conversación simple. ¿Cómo estás hoy?"
        };

        const languageNames = {
            en: "Английский",
            ru: "Русский", 
            es: "Испанский"
        };

        // Системные промпты для персонажей
        const characterPrompts = {
            male: {
                en: "You are Alex, a friendly and patient English tutor with 5 years of teaching experience. You love helping students improve their language skills. You speak in a warm, encouraging manner and always provide constructive feedback. You adapt your teaching style to the student's level and make learning fun and engaging.",
                ru: "Ты Алекс, дружелюбный и терпеливый преподаватель русского языка с 5-летним опытом преподавания. Ты любишь помогать студентам улучшать их языковые навыки. Ты говоришь тепло и ободряюще, всегда даешь конструктивную обратную связь. Ты адаптируешь свой стиль преподавания под уровень студента и делаешь обучение интересным и увлекательным.",
                es: "Eres Alex, un tutor de español amigable y paciente con 5 años de experiencia en enseñanza. Te encanta ayudar a los estudiantes a mejorar sus habilidades lingüísticas. Hablas de manera cálida y alentadora, siempre proporcionas retroalimentación constructiva. Adaptas tu estilo de enseñanza al nivel del estudiante y haces que el aprendizaje sea divertido y atractivo."
            },
            female: {
                en: "You are Maria, a cheerful and supportive English tutor with 3 years of teaching experience. You enjoy helping students learn and speak the language confidently. You have a nurturing teaching style and create a comfortable learning environment. You focus on practical conversation skills and real-world applications.",
                ru: "Ты Мария, дружелюбная и поддерживающая преподаватель русского языка с 3-летним опытом преподавания. Ты любишь помогать студентам учиться и уверенно говорить на языке. У тебя заботливый стиль преподавания, и ты создаешь комфортную среду для обучения. Ты фокусируешься на практических навыках разговора и реальном применении языка.",
                es: "Eres Maria, una tutora de español alegre y solidaria con 3 años de experiencia en enseñanza. Te gusta ayudar a los estudiantes a aprender y hablar el idioma con confianza. Tienes un estilo de enseñanza nutritivo y creas un ambiente de aprendizaje cómodo. Te enfocas en habilidades de conversación práctica y aplicaciones del mundo real."
            }
        };

        const characterDescriptions = {
            male: {
                en: "Alex - Experienced English tutor with 5 years of teaching",
                ru: "Алекс - Опытный преподаватель русского языка с 5-летним стажем",
                es: "Alex - Tutor de español experimentado con 5 años de enseñanza"
            },
            female: {
                en: "Maria - Friendly English tutor with 3 years of experience",
                ru: "Мария - Дружелюбная преподаватель русского языка с 3-летним опытом",
                es: "Maria - Tutora de español amigable con 3 años de experiencia"
            }
        };

        // Функции для работы с историей чатов
        function saveChatHistory() {
            if (selectedLanguage && selectedCharacter) {
                const key = `chat_${selectedLanguage}_${selectedCharacter}`;
                // Сохраняем только постоянные сообщения, исключая временные
                const messagesToSave = chatMessages.filter(msg => !msg.isTemporary);
                localStorage.setItem(key, JSON.stringify(messagesToSave));
            }
        }

        function loadChatHistory() {
            if (selectedLanguage && selectedCharacter) {
                const key = `chat_${selectedLanguage}_${selectedCharacter}`;
                const saved = localStorage.getItem(key);
                if (saved) {
                    chatMessages = JSON.parse(saved);
                    return true;
                }
            }
            return false;
        }

        function clearChatHistory() {
            if (selectedLanguage && selectedCharacter) {
                const key = `chat_${selectedLanguage}_${selectedCharacter}`;
                localStorage.removeItem(key);
            }
        }

        // Функция для отслеживания прогресса оценки
        function getAssessmentProgress() {
            if (selectedLanguage && selectedCharacter) {
                const key = `assessment_${selectedLanguage}_${selectedCharacter}`;
                const saved = localStorage.getItem(key);
                return saved ? JSON.parse(saved) : { currentQuestion: 0, completed: false };
            }
            return { currentQuestion: 0, completed: false };
        }

        function saveAssessmentProgress(progress) {
            if (selectedLanguage && selectedCharacter) {
                const key = `assessment_${selectedLanguage}_${selectedCharacter}`;
                localStorage.setItem(key, JSON.stringify(progress));
            }
        }

        function clearCurrentChat() {
            if (confirm('Вы уверены, что хотите очистить историю этого чата?')) {
                clearChatHistory();
                
                // Сбрасываем прогресс оценки
                const assessmentKey = `assessment_${selectedLanguage}_${selectedCharacter}`;
                localStorage.removeItem(assessmentKey);
                
                chatMessages = [];
                
                // Создаем новое приветственное сообщение с первым вопросом оценки
                const characterName = selectedCharacter === 'male' ? 'Алекс' : 'Мария';
                const assessmentQuestions = {
                    ru: [
                        "Расскажите о себе: где вы учились, чем увлекаетесь?",
                        "Прочитайте и перескажите короткий абзац текста (можно дать текст заранее).",
                        "Как вы понимаете разницу между словами «ложить» и «класть»?",
                        "Составьте связное предложение с использованием слов «тем не менее», «впрочем», «однако».",
                        "Послушайте короткий отрывок (например, новость или диалог) и перескажите, о чём он."
                    ],
                    en: [
                        "Can you introduce yourself and describe your daily routine?",
                        "Listen to a short audio clip (e.g., weather forecast) and explain what you understood.",
                        "What is the difference between present perfect and past simple? Give examples.",
                        "Read a short paragraph and summarize it in your own words.",
                        "Make a sentence using the words although, meanwhile, and however."
                    ],
                    es: [
                        "¿Puedes presentarte y contarme cómo es un día típico para ti?",
                        "Lee este párrafo corto y dime de qué trata (текст можно дать отдельно).",
                        "¿Cuál es la diferencia entre los tiempos pretérito indefinido y pretérito imperfecto?",
                        "Escucha este audio breve y dime qué ocurrió.",
                        "Forma una oración con aunque, sin embargo, y mientras tanto."
                    ]
                };
                
                const firstQuestion = assessmentQuestions[selectedLanguage][0];
                const welcomeMessage = {
                    role: 'assistant',
                    content: `Привет! Я ${characterName}, ваш преподаватель ${languageNames[selectedLanguage].toLowerCase()}. ${characterDescriptions[selectedCharacter][selectedLanguage]}. Давайте начнем с оценки вашего уровня!\n\n**${firstQuestion}**`
                };
                chatMessages = [welcomeMessage];
                saveChatHistory();
                
                                                // Инициализируем прогресс оценки
                                saveAssessmentProgress({ currentQuestion: 0, completed: false });
                renderMessages();
            }
        }

        // Проверяем статус сервера при загрузке
        window.onload = function() {
            // Устанавливаем статус как работающий по умолчанию
            serverStatus = 'ok';
            updateServerStatusDisplay('✅ Сервер работает (демо-режим)', 'status-ok');
            updateButtonStates();
            
            // Пытаемся проверить статус в фоне, но не блокируем интерфейс
            checkServerStatusBackground();
        };

        async function checkServerStatusBackground() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                console.log('Статус сервера:', data);
                
                if (data.status === 'ok') {
                    serverStatus = 'ok';
                    updateServerStatusDisplay(`✅ ${data.message}`, 'status-ok');
                } else if (data.status === 'warning') {
                    serverStatus = 'warning';
                    updateServerStatusDisplay(`⚠️ ${data.message}`, 'status-warning');
                } else {
                    serverStatus = 'error';
                    updateServerStatusDisplay(`❌ ${data.message}`, 'status-error');
                }
            } catch (error) {
                console.error('Ошибка проверки статуса:', error);
                serverStatus = 'warning';
                updateServerStatusDisplay('⚠️ Сервер работает (демо-режим)', 'status-warning');
            }
            
            updateButtonStates();
        }

        function updateServerStatusDisplay(message, statusClass) {
            const statusDiv = document.getElementById('serverStatus');
            statusDiv.innerHTML = `
                <span class="status-indicator ${statusClass}"></span>
                <span>${message}</span>
            `;
        }

        function updateButtonStates() {
            const canStart = serverStatus === 'ok' || serverStatus === 'warning';
            
            console.log('Сервер доступен:', canStart, 'Статус:', serverStatus);
            document.getElementById('enBtn').disabled = false; // Всегда активные
            document.getElementById('ruBtn').disabled = false;
            document.getElementById('esBtn').disabled = false;
        }

        function selectLanguage(lang) {
            console.log('Попытка выбора языка:', lang);
            
            selectedLanguage = lang;
            document.getElementById('selectedLanguageName').textContent = languageNames[lang];
            showCharacterSelect();
        }

        function showCharacterSelect() {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('chatContainer').style.display = 'none'; // Скрываем чат
            document.getElementById('characterSelect').style.display = 'block';
            document.getElementById('characterTitle').textContent = `Выберите персонажа для изучения ${languageNames[selectedLanguage]}`;
            document.getElementById('maleDescription').textContent = characterDescriptions.male[selectedLanguage];
            document.getElementById('femaleDescription').textContent = characterDescriptions.female[selectedLanguage];
            selectedCharacter = null; // Сбрасываем выбранного персонажа при смене языка
        }

        function showMainMenu() {
            document.getElementById('mainMenu').style.display = 'block';
            document.getElementById('characterSelect').style.display = 'none';
            document.getElementById('chatContainer').style.display = 'none'; // Скрываем чат
            document.getElementById('messageInput').value = '';
            document.getElementById('errorContainer').innerHTML = '';
            selectedLanguage = null; // Сбрасываем выбранный язык
            selectedCharacter = null; // Сбрасываем выбранного персонажа
        }

        function selectCharacter(character) {
            selectedCharacter = character;
            
            // Показываем чат
            document.getElementById('characterSelect').style.display = 'none';
            document.getElementById('chatContainer').style.display = 'block';
            
            // Обновляем заголовки
            document.getElementById('chatTitle').textContent = `Чат: ${languageNames[selectedLanguage]}`;
            document.getElementById('chatLanguage').textContent = languageNames[selectedLanguage];
            document.getElementById('chatCharacter').textContent = character === 'male' ? 'Алекс' : 'Мария';
            
            // Загружаем историю чата или создаем новую
            const hasHistory = loadChatHistory();
            
            if (!hasHistory) {
                // Если истории нет, создаем приветственное сообщение с первым вопросом оценки
                const characterName = character === 'male' ? 'Алекс' : 'Мария';
                const assessmentQuestions = {
                    ru: [
                        "Расскажите о себе: где вы учились, чем увлекаетесь?",
                        "Прочитайте и перескажите короткий абзац текста (можно дать текст заранее).",
                        "Как вы понимаете разницу между словами «ложить» и «класть»?",
                        "Составьте связное предложение с использованием слов «тем не менее», «впрочем», «однако».",
                        "Послушайте короткий отрывок (например, новость или диалог) и перескажите, о чём он."
                    ],
                    en: [
                        "Can you introduce yourself and describe your daily routine?",
                        "Listen to a short audio clip (e.g., weather forecast) and explain what you understood.",
                        "What is the difference between present perfect and past simple? Give examples.",
                        "Read a short paragraph and summarize it in your own words.",
                        "Make a sentence using the words although, meanwhile, and however."
                    ],
                    es: [
                        "¿Puedes presentarte y contarme cómo es un día típico para ti?",
                        "Lee este párrafo corto y dime de qué trata (текст можно дать отдельно).",
                        "¿Cuál es la diferencia entre los tiempos pretérito indefinido y pretérito imperfecto?",
                        "Escucha este audio breve y dime qué ocurrió.",
                        "Forma una oración con aunque, sin embargo, y mientras tanto."
                    ]
                };
                
                                                const firstQuestion = assessmentQuestions[selectedLanguage][0];
                                const welcomeMessage = {
                                    role: 'assistant',
                                    content: `Привет! Я ${characterName}, ваш преподаватель ${languageNames[selectedLanguage].toLowerCase()}. ${characterDescriptions[character][selectedLanguage]}. Давайте начнем с оценки вашего уровня!\n\n**${firstQuestion}**`
                                };
                                chatMessages = [welcomeMessage];
                                saveChatHistory();
                                
                                // Инициализируем прогресс оценки
                                saveAssessmentProgress({ currentQuestion: 0, completed: false });
            }
            
            renderMessages();
        }

        function renderMessages() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';
            
            chatMessages.forEach(message => {
                // Пропускаем временные сообщения при рендеринге
                if (message.isTemporary) {
                    return;
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${message.role}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                
                // Безопасно обрабатываем контент, избегая XSS
                let content = message.content
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;')
                    // Преобразуем markdown-подобную разметку в HTML
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n/g, '<br>');
                
                contentDiv.innerHTML = content;
                
                messageDiv.appendChild(contentDiv);
                messagesDiv.appendChild(messageDiv);
            });
            
            // Прокручиваем к последнему сообщению
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.textContent = message;
            errorContainer.style.display = 'block';
        }

        function clearError() {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.style.display = 'none';
        }

        async function sendMessage(event) {
            event.preventDefault();
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const message = input.value.trim();
            
            if (!message) return;

            console.log('Отправка сообщения...');

            // Добавляем сообщение пользователя
            chatMessages.push({ role: 'user', content: message });
            input.value = '';
            renderMessages();

            // Блокируем кнопку и показываем индикатор загрузки
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="loading"></span> Отправка...';
            
            // Добавляем временное сообщение загрузки
            const loadingMessage = { role: 'assistant', content: 'Печатаю...', isTemporary: true };
            chatMessages.push(loadingMessage);
            renderMessages();

            try {
                clearError();
                
                // Подготавливаем сообщения для сервера (без системного промпта)
                const messagesForServer = chatMessages.slice(0, -1); // Убираем сообщение загрузки

                console.log('Отправка запроса к серверу...');

                // Подготавливаем сообщения с системным промптом персонажа
                const systemPrompt = characterPrompts[selectedCharacter][selectedLanguage];
                const messagesWithSystem = [
                    { role: 'system', content: systemPrompt },
                    ...messagesForServer
                ];

                const currentProgress = getAssessmentProgress();
                console.log('Текущий прогресс оценки:', currentProgress);
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messages: messagesWithSystem,
                        language: selectedLanguage,
                        character: selectedCharacter,
                        assessmentProgress: currentProgress
                    })
                });

                console.log('Ответ от сервера:', response.status, response.statusText);

                if (!response.ok) {
                    // При ошибке API используем локальные демо-ответы
                    throw new Error('API недоступен');
                }

                const data = await response.json();
                console.log('Успешный ответ от сервера, режим:', data.mode);
                
                // Убираем временное сообщение загрузки
                chatMessages = chatMessages.filter(msg => !msg.isTemporary);
                
                // Добавляем информацию о режиме работы
                let responseContent = data.message;
                if (data.mode === 'demo' || data.mode === 'fallback' || data.mode === 'error-fallback') {
                    responseContent += '\n\n[Демо-режим]';
                }
                
                chatMessages.push({ 
                    role: 'assistant', 
                    content: responseContent 
                });
                
                // Сохраняем прогресс оценки, если он есть
                if (data.assessmentProgress) {
                    saveAssessmentProgress(data.assessmentProgress);
                }
                
                // Сохраняем историю чата
                saveChatHistory();

            } catch (error) {
                console.error('Error:', error);
                // Убираем временное сообщение загрузки
                chatMessages = chatMessages.filter(msg => !msg.isTemporary);
                
                // Используем локальные демо-ответы при ошибке API
                const demoResponses = {
                    en: {
                        male: [
                            "Great! I can see you're learning English. As your tutor Alex, I'm here to help you improve your skills step by step.",
                            "That's a good start! Remember, practice makes perfect. Let's work on your pronunciation together.",
                            "Excellent progress! Here's a tip from me: try to think in English instead of translating from your native language."
                        ],
                        female: [
                            "Hello! I'm Maria, your friendly English tutor. I'm excited to help you on your language learning journey!",
                            "That's wonderful! I believe everyone can learn a language with the right approach and support.",
                            "You're making great progress! Let me share a helpful tip: try watching English movies with subtitles."
                        ]
                    },
                    ru: {
                        male: [
                            "Отлично! Я Алекс, ваш преподаватель русского языка. Я вижу, что вы серьезно относитесь к обучению.",
                            "Хорошее начало! За 5 лет преподавания я понял, что регулярность - ключ к успеху.",
                            "Отличный прогресс! Мой совет: попробуйте думать на русском языке, а не переводить."
                        ],
                        female: [
                            "Привет! Я Мария, ваш дружелюбный преподаватель русского языка. Рада помочь вам в изучении!",
                            "Это замечательно! Я верю, что каждый может выучить язык при правильном подходе.",
                            "Вы делаете отличные успехи! Мой совет: смотрите русские фильмы с субтитрами."
                        ]
                    },
                    es: {
                        male: [
                            "¡Excelente! Soy Alex, tu tutor de español. Veo que te tomas en serio el aprendizaje del idioma.",
                            "¡Buen comienzo! En 5 años de enseñanza he aprendido que la constancia es la clave del éxito.",
                            "¡Excelente progreso! Mi consejo: intenta pensar en español en lugar de traducir."
                        ],
                        female: [
                            "¡Hola! Soy Maria, tu tutora amigable de español. ¡Estoy emocionada de ayudarte en tu viaje de aprendizaje!",
                            "¡Eso es maravilloso! Creo que todos pueden aprender un idioma con el enfoque correcto.",
                            "¡Estás progresando mucho! Mi consejo: mira películas en español con subtítulos."
                        ]
                    }
                };
                
                const responses = demoResponses[selectedLanguage][selectedCharacter];
                const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                
                chatMessages.push({ 
                    role: 'assistant', 
                    content: randomResponse + '\n\n[Локальный демо-режим]'
                });
                
                // Сохраняем историю чата
                saveChatHistory();
                
            } finally {
                // Восстанавливаем кнопку
                sendBtn.disabled = false;
                sendBtn.textContent = 'Отправить';
                renderMessages();
            }
        }
    </script>
</body>
</html>
